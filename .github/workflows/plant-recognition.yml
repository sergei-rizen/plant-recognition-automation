name: Plant Image Recognition

on:
  repository_dispatch:
    types: [coda_process_plant]

jobs:
  recognize-plant:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      - name: Install Python dependencies
        run: pip install requests google-generativeai # <-- Updated libraries
      
      - name: Process plant image and Update Coda
        run: python process_plant.py
        env:
          GOOGLE_DRIVE_API_KEY: ${{ secrets.GOOGLE_DRIVE_API_KEY }}
          GOOGLE_VISION_API_KEY: ${{ secrets.GOOGLE_VISION_API_KEY }}
          PLANTNET_API_KEY: ${{ secrets.PLANTNET_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }} # <-- New secret
          
          CODA_API_TOKEN: ${{ secrets.CODA_API_TOKEN }}
          CODA_DOC_ID: ${{ secrets.CODA_DOC_ID }}
          CODA_TABLE_ID: ${{ secrets.CODA_TABLE_ID }}

          IMAGE_ID: ${{ github.event.client_payload.image_id }}
          ROW_ID: ${{ github.event.client_payload.row_id }}
          IMAGE_NAME: ${{ github.event.client_payload.image_name }}
